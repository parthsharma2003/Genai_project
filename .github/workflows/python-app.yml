# .github/workflows/python-app.yml

name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€

on: [push]

jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest   # switched to GitHub-hosted runner for better Python support

    env:
      # Confluence & Google API credentials (set these in Settings â†’ Secrets)
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      CONF_DOMAIN:      ${{ secrets.CONF_DOMAIN }}
      CONF_SPACE:       ${{ secrets.CONF_SPACE }}
      CONF_USER:        ${{ secrets.CONF_USER }}
      CONF_TOKEN:       ${{ secrets.CONF_TOKEN }}
      PROJECT_NAME:     "MyProject"
      CHANGELOG_FORMAT: "markdown"
      STAGE_NAME:       "github-actions"

    steps:
      - run: echo "ðŸŽ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "ðŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: whoami
      - run: hostname
      - run: echo "ðŸ”Ž The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v4
      - run: echo "ðŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "ðŸ–¥ï¸ The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: ls ${{ github.workspace }}
      - run: echo "ðŸ This job's status is ${{ job.status }}."

      # â€”â€”â€” new Python & Confluence steps below â€”â€”â€”

      - name: Set up Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-generativeai requests jinja2 markdown tenacity

      - name: Gather commit metadata
        id: metadata
        run: |
          echo "COMMIT_HASH=${GITHUB_SHA}" >> $GITHUB_ENV
          echo "COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')" >> $GITHUB_ENV

          echo "COMMIT_MSG<<EOF" >> $GITHUB_ENV
          git log -1 --pretty=%B >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "COMMIT_DIFF<<EOF" >> $GITHUB_ENV
          git diff ${{ github.sha }}^! >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Run changelog agent
        run: python adk_agent/agent.py

      - name: Upload changelog artifacts
        uses: actions/upload-artifact@v4      # updated to v4 for better reliability
        with:
          name: changelog
          path: |
            output/changelog.md
            output/changelog.html
